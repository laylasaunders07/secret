<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Home</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 2em;
      max-width: 600px;
    }
    a {
      color: #007bff;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }

    h1, h3 {
      margin-top: 1em;
    }

    /* post card container: use stretch so children fill height */
    .post-card {
      background: #e3f2fd;
      border-radius: 12px;
      padding: 0.6em 0.75em;      /* inner padding for the card */
      margin-bottom: 1.5em;
      display: flex;
      gap: 0.6em;
      align-items: stretch;       /* <--- important: lets textarea stretch vertically */
      justify-content: space-between;
      min-height: 56px;           /* compact height; will grow with textarea content */
      box-shadow: none;           /* no shadow so textarea blends in */
      box-sizing: border-box;
    }
    
    /* textarea: take all remaining space and stretch fully */
    .post-card textarea {
      flex: 1;                    /* take remaining width */
      min-height: 44px;           /* minimum editable height */
      height: 100%;               /* fill the card vertically */
      align-self: stretch;        /* ensure full height inside flex container */
      background: transparent;    /* visually blend with card */
      border: none;               /* no border */
      outline: none;
      resize: none;               /* optional: disallow manual resize to preserve layout */
      padding: 0;                 /* no internal padding so text aligns with card */
      margin: 0;
      line-height: 1.4;
      font-family: inherit;
      font-size: 1rem;
      color: #111;
      box-sizing: border-box;
      overflow: auto;             /* scroll if multiple lines exceed container */
    }
    
    /* button: fixed size, right side, vertically centered */
    .post-card button {
      flex-shrink: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
      background: none;
      border: none;
      padding: 0;
      border-radius: 8px;
      cursor: pointer;
      align-self: center;
      transition: background 0.12s ease, transform 0.3s ease;
    }
    
    /* hover effect for button */
    .post-card button:hover {
      background: rgba(25,118,210,0.12);
    }
    
    /* svg icon base */
    .post-card button svg {
      width: 22px;
      height: 22px;
      fill: #1976d2;
      transition: opacity 0.3s ease, transform 0.6s ease;
    }
    
    /* loading (spinning + shaded) */
    .post-card button.loading svg {
      opacity: 0.6;
      filter: grayscale(1);
      animation: spin 0.6s linear infinite;
    }
    
    /* spin animation */
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .message {
      background: #f5f5f5;
      padding: 0.6em;
      margin: 0.5em 0;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .message .like-btn {
      flex-shrink: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      margin-right: 4px; /* ✅ fixes right cutoff */
      background: none;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.12s ease, transform 0.3s ease;
    }
    
    .message .like-btn:hover {
      background: rgba(25,118,210,0.12);
    }
    
    .message .like-btn svg {
      width: 20px;
      height: 20px;
      fill: #1976d2;
      transition: opacity 0.3s ease, transform 0.6s ease;
    }
    
    .message .like-btn.loading svg {
      opacity: 0.6;
      filter: grayscale(1);
      animation: spin 0.6s linear infinite;
    }

    #search {
      width: 100%;
      padding: 0.6em;
      margin: 0.5em 0 1em 0;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    /* Posts feed */
    .message {
      background: #f5f5f5;
      padding: 0.6em;
      margin: 0.5em 0;
      border-radius: 6px;
    }

    .post-header {
      font-weight: bold;
    }

    small {
      color: gray;
    }

    /* Hover highlight for all cards */
    .post:hover,
    .message:hover,
    .user:hover,
    .comment:hover {
      background: #e3f2fd !important;
      transition: background 0.2s ease;
    }

    .like-btn {
      flex-shrink: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      background: none;
      border: none;
      padding: 0;
      margin: 0 2px 0 6px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.12s ease, transform 0.3s ease;
    }
    
    .like-btn:hover {
      background: rgba(0, 0, 0, 0.05);
    }
    
    .like-btn svg {
      width: 20px;
      height: 20px;
      fill: #000; /* black */
      transition: transform 0.3s ease, opacity 0.3s ease;
    }
    
    .like-btn.liked svg {
      fill: #000;
      transform: scale(1.1);
    }
    
    .like-btn.loading svg {
      opacity: 0.6;
      animation: spin 0.6s linear infinite;
    }
  </style>
</head>
<body>
  <h1>Home</h1>

  <!-- Create Post / Login Prompt -->
  <div id="createPostCard"></div>

  <!-- Search + Posts -->
  <h3>Posts</h3>
  <input type="text" id="search" placeholder="Search posts..." oninput="filterMessages()">
  <div id="messages"></div>

  <script>
    const API_URL = "https://gentle-wind-dea4.silly-7f7.workers.dev";
    const SECRET_KEY = "alva-the-fortnite-god";
    let allMessages = [];

    // Initialize page
    loadMessages();
    setupPostCard();

    // --- RENDER POST CARD OR LOGIN PROMPT ---
    function setupPostCard() {
      const container = document.getElementById("createPostCard");
      const user = JSON.parse(localStorage.getItem("user") || "null");
    
      if (!user || !user.username) {
        container.innerHTML = `
          <div style="text-align:center;">
            <p>You need to be logged in to post.</p>
            <p>
              <a href="login.html">Login</a> or
              <a href="create.html">Create an Account</a>
            </p>
          </div>
        `;
        return;
      }
    
      container.innerHTML = `
        <form id="form" class="post-card">
          <textarea id="message" placeholder="Share something..." required></textarea>
          <button type="submit" title="Post">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
              <path d="M12 0a12 12 0 1 0 12 12A12 12 0 0 0 12 0Zm4.91 10.41A1 1 0 0 1 16 11h-2.25a0.25 0.25 0 0 0 -0.25 0.25v7.25a1.5 1.5 0 0 1 -3 0v-7.25a0.25 0.25 0 0 0 -0.25 -0.25H8a1 1 0 0 1 -0.75 -1.66l4 -4.5a1 1 0 0 1 1.5 0l4 4.5a1 1 0 0 1 0.16 1.07Z"></path>
            </svg>
          </button>
        </form>
      `;
    
      const form = document.getElementById("form");
      const loading = document.getElementById("loading");
      const button = form.querySelector("button");
    
      form.addEventListener("submit", async e => {
        e.preventDefault();
      
        const button = form.querySelector("button");
        const messageInput = document.getElementById("message");
        const messageText = messageInput.value.trim();
      
        if (!messageText) {
          alert("Please enter a message before posting.");
          return;
        }
      
        // Start loading state (dim + spin)
        button.disabled = true;
        button.classList.add("loading");
      
        try {
          await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              key: SECRET_KEY,
              action: "post",
              name: user.username,
              message: messageText
            })
          });
      
          form.reset();
          loadMessages();
        } finally {
          // End loading state
          button.disabled = false;
          button.classList.remove("loading");
        }
      });
    }

    // --- LOAD & RENDER MESSAGES ---
    async function loadMessages() {
      const res = await fetch(API_URL);
      allMessages = await res.json();
      renderMessages(allMessages);
    }

    async function renderMessages(data) {
      const container = document.getElementById("messages");
      container. = "";
    
      const user = JSON.parse(localStorage.getItem("user") || "null");
      let likedPosts = [];
    
      // ✅ Fetch liked posts for current user (if logged in)
      if (user && user.username) {
        try {
          const res = await fetch(`${API_URL}?likesFor=${encodeURIComponent(user.username)}`);
          const likeData = await res.json();
          likedPosts = likeData.likedPosts || []; // server should return an array of liked post IDs
        } catch (err) {
          console.warn("Could not load liked posts:", err);
        }
      }
    
      data.forEach(msg => {
        const isLiked = likedPosts.includes(msg.id);
    
        const div = document.createElement("div");
        div.className = "message";
        div.innerHTML = `
          <div class="post-content">
            <div class="post-header">
              <strong>${msg.name || "Unknown User"}</strong>
              <a href="user.html?id=${encodeURIComponent(msg.userId)}&from=index.html">
                @${msg.username}
              </a>
            </div>
            <div class="post-message">${msg.message}</div>
            <small>${new Date(msg.timestamp).toLocaleString()}</small>
          </div>
          <button class="like-btn" data-postid="${msg.id}" title="Like">
            <svg class="heart-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 14 14">
              <path d="M13.7499 4.94124c-0.0233 -1.58206 -0.919 -3.14007 -2.2971 -3.78222 -0.7003 -0.326348 -1.51249 -0.407627 -2.35948 -0.13877 -0.70546 0.22393 -1.41202 0.68288 -2.09333 1.40446 -0.68131 -0.72158 -1.38786 -1.18053 -2.09333 -1.40446 -0.84699 -0.268857 -1.65918 -0.187578 -2.35952 0.13877C1.1691 1.80117 0.273441 3.35918 0.250055 4.94124L0.25 4.94123v0.0074c0 2.30748 1.37229 4.35177 2.82563 5.78657 0.73363 0.7242 1.50803 1.3137 2.18354 1.7253 0.33755 0.2056 0.65713 0.371 0.94028 0.4865 0.2705 0.1104 0.55272 0.1943 0.80054 0.1943 0.24782 0 0.53004 -0.0839 0.80054 -0.1943 0.28315 -0.1155 0.60273 -0.2809 0.94028 -0.4865 0.67552 -0.4116 1.44989 -1.0011 2.18359 -1.7253C12.3777 9.3004 13.75 7.25611 13.75 4.94863h0.0001l-0.0002 -0.00739Z"></path>
            </svg>
          </button>
        `;
    
        // 👇 Clicking anywhere (except button) opens post
        div.addEventListener("click", e => {
          if (e.target.closest(".like-btn")) return;
          if (e.target.tagName.toLowerCase() !== "a") {
            window.location.href = `post.html?id=${msg.id}&from=index.html`;
          }
        });
    
        // 👇 Button click logic
        const likeButton = div.querySelector(".like-btn");
        likeButton.addEventListener("click", async e => {
          e.preventDefault();
          e.stopPropagation();
    
          const user = JSON.parse(localStorage.getItem("user") || "null");
          if (!user || !user.username) {
            alert("You need to be logged in to like posts.");
            return;
          }
    
          likeButton.classList.add("loading");
    
          try {
            const res = await fetch(API_URL, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                key: SECRET_KEY,
                action: "like",
                postId: msg.id,
                username: user.username
              })
            });
    
            const result = await res.json();
            likeButton.classList.remove("loading");
    
            if (result.error) {
              alert(result.error);
            } else if (result.message === "Already liked") {
              alert("You’ve already liked this post.");
            } else if (result.success) {
              likeButton.innerHTML = likedHeartSVG();
            }
          } catch (err) {
            likeButton.classList.remove("loading");
            alert("Failed to like post: " + err.message);
          }
        });
    
        container.appendChild(div);
      });
    }
    
    function unlikedHeartSVG() {
      return `
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14" height="20" width="20">
        <path fill="#1976d2" d="M13.7499 4.94124c-0.0233 -1.58206 -0.919 -3.14007 -2.2971 -3.78222 -0.7003 -0.326348 -1.51249 -0.407627 -2.35948 -0.13877 -0.70546 0.22393 -1.41202 0.68288 -2.09333 1.40446 -0.68131 -0.72158 -1.38786 -1.18053 -2.09333 -1.40446 -0.84699 -0.268857 -1.65918 -0.187578 -2.35952 0.13877C1.1691 1.80117 0.273441 3.35918 0.250055 4.94124L0.25 4.94123v0.0074c0 2.30748 1.37229 4.35177 2.82563 5.78657 0.73363 0.7242 1.50803 1.3137 2.18354 1.7253 0.33755 0.2056 0.65713 0.371 0.94028 0.4865 0.2705 0.1104 0.55272 0.1943 0.80054 0.1943 0.24782 0 0.53004 -0.0839 0.80054 -0.1943 0.28315 -0.1155 0.60273 -0.2809 0.94028 -0.4865 0.67552 -0.4116 1.44989 -1.0011 2.18359 -1.7253C12.3777 9.3004 13.75 7.25611 13.75 4.94863h0.0001l-0.0002 -0.00739Z"></path>
      </svg>`;
    }
    
    function likedHeartSVG() {
      return `
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14" height="20" width="20">
        <path fill="#1976d2" d="M7.48005 3.59438c0.71376 -0.85612 1.39891 -1.29991 1.99468 -1.48479 0.58847 -0.1826 1.12707 -0.12522 1.59267 0.08688 0.9563 0.43558 1.6626 1.56097 1.6826 2.76267 -0.002 1.85536 -1.1487 3.6184 -2.5395 4.96058 -0.68648 0.66258 -1.40702 1.19708 -2.02006 1.56218 -0.30673 0.1827 -0.57827 0.3181 -0.79818 0.4058 -0.23528 0.0938 -0.36027 0.1123 -0.39227 0.1123 -0.03201 0 -0.157 -0.0185 -0.39228 -0.1123 -0.21991 -0.0877 -0.49144 -0.2231 -0.79818 -0.4058 -0.61303 -0.3651 -1.33357 -0.8996 -2.02008 -1.5621C2.39872 8.57767 1.25197 6.81467 1.25 4.95932c0.01995 -1.20171 0.7263 -2.32715 1.6826 -2.76277 0.46565 -0.21212 1.00425 -0.26952 1.59268 -0.08693 0.59576 0.18487 1.28091 0.62864 1.99467 1.48476 0.11875 0.14243 0.29461 0.22478 0.48005 0.22478s0.3613 -0.08235 0.48005 -0.22478Z"></path>
      </svg>`;
    }

    function filterMessages() {
      const term = document.getElementById("search").value.toLowerCase();
      const filtered = allMessages.filter(m =>
        (m.message || "").toLowerCase().includes(term) ||
        (m.username || "").toLowerCase().includes(term) ||
        (m.name || "").toLowerCase().includes(term)
      );
      renderMessages(filtered);
    }
  </script>
</body>
</html>
