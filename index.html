<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="stylesheet" href="styles.css">
  <meta charset="UTF-8" />
  <title>Home</title>
</head>
<body>
  <h1>Home</h1>

  <!-- Create Post / Login Prompt -->
  <div id="createPostCard"></div>

  <!-- Search + Posts -->
  <div class="tabs">
    <a href="index.html" class="active">Posts</a>
    <a href="users.html">Users</a>
  </div>
  <input type="text" id="search" placeholder="Search posts..." oninput="filterMessages()">
  <div id="messages"></div>

  <script>
    const API_URL = "https://gentle-wind-dea4.silly-7f7.workers.dev";
    const SECRET_KEY = "alva-the-fortnite-god";
    let allMessages = [];

    // Initialize page
    loadMessages();
    setupPostCard();

    // --- RENDER POST CARD OR LOGIN PROMPT ---
    function setupPostCard() {
      const container = document.getElementById("createPostCard");
      const user = JSON.parse(localStorage.getItem("user") || "null");
    
      if (!user || !user.username) {
        container.innerHTML = `
          <div class="post-card" style="text-align:center;">
            <div style="width:100%;">
              <p>You need to be logged in to post.</p>
              <p>
                <a href="login.html">Login</a> or
                <a href="create.html">Create an Account</a>
              </p>
            </div>
          </div>
        `;
        return;
      }
    
      container.innerHTML = `
        <form id="form" class="post-card">
          <textarea id="message" placeholder="Share something..." required></textarea>
          <button type="submit" title="Post">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
              <path d="M12 0a12 12 0 1 0 12 12A12 12 0 0 0 12 0Zm4.91 10.41A1 1 0 0 1 16 11h-2.25a0.25 0.25 0 0 0 -0.25 0.25v7.25a1.5 1.5 0 0 1 -3 0v-7.25a0.25 0.25 0 0 0 -0.25 -0.25H8a1 1 0 0 1 -0.75 -1.66l4 -4.5a1 1 0 0 1 1.5 0l4 4.5a1 1 0 0 1 0.16 1.07Z"></path>
            </svg>
          </button>
        </form>
      `;
    
      const form = document.getElementById("form");
      const loading = document.getElementById("loading");
      const button = form.querySelector("button");
    
      form.addEventListener("submit", async e => {
        e.preventDefault();
      
        const button = form.querySelector("button");
        const messageInput = document.getElementById("message");
        const messageText = messageInput.value.trim();
      
        if (!messageText) {
          alert("Please enter a message before posting.");
          return;
        }
      
        // Start loading state (dim + spin)
        button.disabled = true;
        button.classList.add("loading");
      
        try {
          await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              key: SECRET_KEY,
              action: "post",
              name: user.username,
              message: messageText
            })
          });
      
          form.reset();
          loadMessages();
        } finally {
          // End loading state
          button.disabled = false;
          button.classList.remove("loading");
        }
      });
    }

    // --- LOAD & RENDER MESSAGES ---
    async function loadMessages() {
      const res = await fetch(API_URL);
      allMessages = await res.json();
      renderMessages(allMessages);
    }

    async function renderMessages(data) {
      const container = document.getElementById("messages");
      container.innerHTML = "";
    
      const user = JSON.parse(localStorage.getItem("user") || "null");
      let likedSet = new Set();
    
      // Fetch liked posts for current user (if logged in)
      if (user && user.username) {
        try {
          const res = await fetch(`${API_URL}?likesFor=${encodeURIComponent(user.username)}`);
          const likeData = await res.json();
          const likedPosts = likeData.likedPosts || []; // server returns an array of post IDs
          // Normalize to strings to avoid type mismatch issues (number vs string)
          likedSet = new Set(likedPosts.map(id => String(id)));
        } catch (err) {
          console.warn("Could not load liked posts:", err);
          likedSet = new Set();
        }
      }
    
      data.forEach(msg => {
        // Determine liked state using normalized string comparison
        const isLiked = likedSet.has(String(msg.id));
    
        const div = document.createElement("div");
        div.className = "message";
        div.innerHTML = `
          <div class="post-header" style="cursor: default;">
            <strong>${msg.name || "Unknown User"}</strong>
            <a href="user.html?id=${encodeURIComponent(msg.userId)}&from=index.html" style="color: #007bff;">
              @${msg.username}
            </a>
          </div>
          <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
            <div class="post-message" style="flex:1;">${msg.message}</div>
            <button class="like-btn" title="Like" data-postid="${msg.id}" aria-pressed="${isLiked}">
              ${isLiked ? likedHeartSVG() : unlikedHeartSVG()}
            </button>
          </div>
          <small>${(msg.likes || 0)} Like${(msg.likes || 0) === 1 ? '' : 's'}</small>
        `;
    
        // Clicking anywhere (except button) opens post
        div.addEventListener("click", e => {
          if (e.target.closest(".like-btn")) return;
          if (e.target.tagName.toLowerCase() !== "a") {
            window.location.href = `post.html?id=${msg.id}&from=index.html`;
          }
        });
    
        // Button click logic
        const likeButton = div.querySelector(".like-btn");
        likeButton.addEventListener("click", async e => {
          e.preventDefault();
          e.stopPropagation();
    
          const currentUser = JSON.parse(localStorage.getItem("user") || "null");
          if (!currentUser || !currentUser.username) {
            alert("You need to be logged in to like posts.");
            return;
          }
    
          likeButton.classList.add("loading");
    
          try {
            const res = await fetch(API_URL, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                key: SECRET_KEY,
                action: "like",
                postId: msg.id,
                username: currentUser.username
              })
            });
    
            const result = await res.json();
            likeButton.classList.remove("loading");
    
            if (result.error) {
              alert(result.error);
              return;
            }
    
            // Update button SVG & aria-pressed based on backend result
            if (result.liked) {
              likeButton.innerHTML = likedHeartSVG();
              likeButton.setAttribute("aria-pressed", "true");
              likedSet.add(String(msg.id));
            } else {
              likeButton.innerHTML = unlikedHeartSVG();
              likeButton.setAttribute("aria-pressed", "false");
              likedSet.delete(String(msg.id));
            }
    
            // Update like count text (use result.likeCount if backend returns it, otherwise adjust locally)
            const likeLabel = div.querySelector("small");
            let newCount = null;
            if (typeof result.likeCount !== "undefined") {
              newCount = Number(result.likeCount);
            } else {
              // adjust client-side: increment or decrement based on result.liked
              const current = Number(msg.likes || 0);
              newCount = result.liked ? current + 1 : Math.max(0, current - 1);
            }
            msg.likes = newCount;
            if (likeLabel) {
              likeLabel.textContent = `${msg.likes} Like${msg.likes === 1 ? '' : 's'}`;
            }
          } catch (err) {
            likeButton.classList.remove("loading");
            alert("Failed to like post: " + err.message);
          }
        });
    
        container.appendChild(div);
      });
    }
    
    function unlikedHeartSVG() {
      return `
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="22" height="22">
        <path fill="none" stroke="#1976d2" stroke-width="2" d="M12 21s-7.5-4.65-10-9.5C.4 6.44 2.6 3 6.2 3c1.9 0 3.5 1.1 4.3 2.7C11.3 4.1 12.9 3 14.8 3c3.6 0 5.8 3.44 4.2 8.5C19.5 16.35 12 21 12 21z"/>
      </svg>`;
    }
    
    function likedHeartSVG() {
      return `
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="22" height="22">
        <path fill="#1976d2" d="M12 21s-7.5-4.65-10-9.5C.4 6.44 2.6 3 6.2 3c1.9 0 3.5 1.1 4.3 2.7C11.3 4.1 12.9 3 14.8 3c3.6 0 5.8 3.44 4.2 8.5C19.5 16.35 12 21 12 21z"/>
      </svg>`;
    }

    function filterMessages() {
      const term = document.getElementById("search").value.toLowerCase();
      const filtered = allMessages.filter(m =>
        (m.message || "").toLowerCase().includes(term) ||
        (m.username || "").toLowerCase().includes(term) ||
        (m.name || "").toLowerCase().includes(term)
      );
      renderMessages(filtered);
    }
  </script>
</body>
</html>
