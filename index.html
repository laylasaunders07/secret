<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>test page</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 2em; max-width: 600px; }
    input, textarea { width: 100%; padding: 0.6em; margin: 0.5em 0; border-radius: 6px; border: 1px solid #ccc; }
    button { padding: 0.6em 1.2em; border: none; border-radius: 6px; background: #1976d2; color: white; cursor: pointer; }
    button:disabled { background: #90caf9; cursor: not-allowed; }
    .message { background: #f5f5f5; padding: 0.6em; margin: 0.5em 0; border-radius: 6px; }
    .loading { display: none; color: #1976d2; font-weight: bold; }
  </style>
</head>
<body>
  <h1>laylas sigma tuff two way database tester in github pages NO ONE leak ts or i will be sad</h1>

  <form id="form">
    <textarea id="message" placeholder="Your message..." required></textarea>
    <button type="submit">Send</button>
    <span id="loading" class="loading">Sending...</span>
  </form>

  <h2>Messages</h2>
  <div id="messages"></div>

  <script>
  const API_URL = "https://gentle-wind-dea4.silly-7f7.workers.dev";
  const SECRET_KEY = "alva-the-fortnite-god";

  async function loadMessages() {
    const res = await fetch(API_URL);
    const data = await res.json();
    const container = document.getElementById("messages");
    container.innerHTML = "";

    data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

    data.forEach(msg => {
      const div = document.createElement("div");
      div.className = "message";

      // Build HTML (inline , name + username same line)
      div.innerHTML = `
        <div class="post-header" style="cursor: default;">
          <strong>${msg.name || "Unknown User"}</strong>
          <a href="user.html?username=${encodeURIComponent(msg.username)}" style="color: #007bff; text-decoration: none;">
            @${msg.username}
          </a>
        </div>
        <div class="post-message" style="cursor: pointer;" onclick="window.location.href='post.html?id=${msg.id}'">
          ${msg.message}
        </div>
        <small style="color: gray;">${new Date(msg.timestamp).toLocaleString()}</small>
      `;

      // Make clicking anywhere else on post open it
      div.addEventListener("click", (e) => {
        // only navigate if the click wasn't on a link
        if (e.target.tagName.toLowerCase() !== "a") {
          window.location.href = `post.html?id=${msg.id}&from=index.html`;
        }
      });

      container.appendChild(div);
    });
  }

  // --- FORM HANDLER ---
  const form = document.getElementById("form");
  const loading = document.getElementById("loading");
  const button = form.querySelector("button");

  form.addEventListener("submit", async e => {
    e.preventDefault();

    button.disabled = true;
    loading.style.display = "inline";

    const messageInput = document.getElementById("message");
    const messageText = messageInput.value.trim();

    const user = JSON.parse(localStorage.getItem("user") || "null");
    if (!user) {
      alert("You must be logged in to post!");
      button.disabled = false;
      loading.style.display = "none";
      return;
    }

    await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        key: SECRET_KEY,
        action: "post",
        name: user.username,
        message: messageText
      })
    });

    form.reset();
    button.disabled = false;
    loading.style.display = "none";
    alert("Post published!");

    loadMessages();
  });

  loadMessages();
</script>
</body>
</html>
