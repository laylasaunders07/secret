<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>All Users</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 2em;
      max-width: 600px;
    }
    a {
      color: #1976d2;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    h1, h3 { margin-top: 1em; }

    /* Logged-in user card */
    .user-card {
      background: #e3f2fd;
      border-radius: 12px;
      padding: 1em;
      margin-bottom: 1.5em;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .user-info { flex-grow: 1; }
    .user-header { font-size: 1.2em; font-weight: 600; }
    .user-header a { margin-left: 0.4em; font-weight: 400; font-size: 0.95em; color: #1976d2; }
    .user-bio { margin: 0.3em 0; font-size: 0.95em; color: #333; }
    .user-followers { font-size: 0.85em; color: gray; }

    /* Users list */
    #searchUsers {
      width: 100%;
      padding: 0.6em;
      margin: 0.5em 0 1em 0;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    .user {
      background: #f5f5f5;
      padding: 0.8em;
      margin: 0.5em 0;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: default; /* normal cursor for whole card */
      transition: background 0.2s ease;
    }
    .user:hover { background: #e3f2fd !important; }
    .user strong { font-size: 1.05em; }
    .user small { color: gray; }

    /* Buttons styled like Like button */
    .follow-btn, .logout-btn {
      flex-shrink: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      background: none;
      border: none;
      border-radius: 8px;
      cursor: pointer; /* pointer only on buttons */
      transition: background 0.12s ease, transform 0.3s ease;
    }
    .follow-btn:hover, .logout-btn:hover { background: rgba(25,118,210,0.12); }
    .follow-btn svg, .logout-btn svg {
      width: 20px;
      height: 20px;
      fill: #1976d2;
      transition: opacity 0.3s ease, transform 0.6s ease;
    }
    .follow-btn.loading svg {
      opacity: 0.6;
      filter: grayscale(1);
      animation: spin 0.6s linear infinite;
    }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    /* Tabs navigation */
    .tabs {
      display: flex;
      align-items: center;
      gap: 2em;
      margin: 1.2em 0 1em 0;
      font-size: 1.25em;
    }
    .tabs a {
      color: black;
      text-decoration: none;
      font-weight: normal;
      transition: font-weight 0.15s ease, color 0.15s ease;
    }
    .tabs a:hover { font-weight: bold; color: black; }
    .tabs a.active { font-weight: bold; color: black; cursor: default; }
  </style>
</head>
<body>
  <h1>All Users</h1>

  <!-- Logged-in user card (blue) -->
  <div id="loggedInCard"></div>

  <div class="tabs">
    <a href="index.html">Posts</a>
    <a href="users.html" class="active">Users</a>
  </div>
  
  <input type="text" id="searchUsers" placeholder="Search users..." oninput="filterUsers()">
  <div id="users"></div>

  <script>
  const API_URL = "https://gentle-wind-dea4.silly-7f7.workers.dev";
  const SECRET_KEY = "alva-the-fortnite-god";
  let allUsers = [];
  let followingSet = new Set(); // user ids the current user follows

  // --- SVG helper functions (swap these if you prefer different icons) ---
  function svgFollowOutline() {
    // outline "follow" icon (person-add)
    return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
      <path d="M12.5 16a3.5 3.5 0 1 0 0 -7 3.5 3.5 0 0 0 0 7m0.5 -5v1h1a.5.5 0 0 1 0 1h-1v1a.5.5 0 0 1 -1 0v-1h-1a.5.5 0 0 1 0 -1h1v-1a.5.5 0 0 1 1 0m-2 -6a3 3 0 1 1 -6 0 3 3 0 0 1 6 0M8 7a2 2 0 1 0 0 -4 2 2 0 0 0 0 4"/>
      <path d="M8.256 14a4.5 4.5 0 0 1 -0.229 -1.004H3c.001 -0.246.154 -0.986.832 -1.664C4.484 10.68 5.711 10 8 10q.39 0 .74.025c.226 -.341.496 -.65.804 -.918Q8.844 9.002 8 9c-5 0 -6 3 -6 4s1 1 1 1z"/>
    </svg>`;
  }

  function svgFollowFilled() {
    // filled "followed" icon (person-dash) — visible when followed
    return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
      <path d="M12.5 16a3.5 3.5 0 1 0 0 -7 3.5 3.5 0 0 0 0 7"/>
      <path d="M11 12h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1 0 -1"/>
      <path d="M11 5a3 3 0 1 1 -6 0 3 3 0 0 1 6 0"/>
      <path d="M8.256 14a4.5 4.5 0 0 1 -0.229 -1.004H3c.001 -0.246.154 -0.986.832 -1.664C4.484 10.68 5.711 10 8 10q.39 0 .74.025c.226 -.341.496 -.65.804 -.918Q8.844 9.002 8 9c-5 0 -6 3 -6 4s1 1 1 1z"/>
    </svg>`;
  }

  function svgLogout() {
    // logout icon (person-fill-x) for top card button
    return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
      <path d="M11 5a3 3 0 1 1 -6 0 3 3 0 0 1 6 0"/>
      <path d="M12.5 16a3.5 3.5 0 1 0 0 -7 3.5 3.5 0 0 0 0 7"/>
      <path d="M11.854 11.146a.5.5 0 1 1 .708.708l-.647.646.647.646a.5.5 0 0 1 -.708.708l-.646-.647-.646.647a.5.5 0 0 1 -.708-.708l.647-.646-.647-.646a.5.5 0 0 1 .708-.708"/>
    </svg>`;
  }

  // ----------------- Load users & following -----------------
  async function loadUsers() {
    const res = await fetch(`${API_URL}?type=users`);
    allUsers = await res.json();
    // Load following set (if logged in) before rendering users, so button state persists on refresh
    await loadFollowingForCurrentUser();
    renderUsers(allUsers);
    loadLoggedInUser(); // top card
  }

  async function loadFollowingForCurrentUser() {
    followingSet = new Set();
    const currentUser = JSON.parse(localStorage.getItem("user") || "null");
    if (!currentUser || !currentUser.username) return;

    try {
      const res = await fetch(`${API_URL}?followingFor=${encodeURIComponent(currentUser.username)}`);
      const data = await res.json();
      // server should return { following: [<followedId>, ...] } or { following: [] }
      const list = data.following || data.followedIds || data.followingIds || [];
      list.forEach(id => followingSet.add(String(id)));
    } catch (err) {
      console.warn("Could not load following list:", err);
    }
  }

  // ----------------- Render users -----------------
  function renderUsers(users) {
    const loggedInUser = JSON.parse(localStorage.getItem("user") || "null");
    const container = document.getElementById("users");

    container.innerHTML = users.map(u => {
      const isMe = loggedInUser && String(loggedInUser.pk_user_id) === String(u.id);
      // determine initial button based on followingSet
      let buttonHtml = "";
      if (!isMe) {
        const followed = followingSet.has(String(u.id));
        buttonHtml = `
          <button class="follow-btn" data-userid="${u.id}" aria-pressed="${followed}">
            ${followed ? svgFollowFilled() : svgFollowOutline()}
          </button>
        `;
      }

      return `
        <div class="user">
          <div style="flex-grow:1;">
            <strong>${u.name || u.username}</strong>
            <a href="user.html?id=${u.id}&from=users.html">@${u.username}</a><br>
            <em>${u.bio || "No bio yet"}</em><br>
            <small class="user-followers">Followers: —</small>
          </div>
          ${buttonHtml}
        </div>
      `;
    }).join("");

    attachFollowButtonHandlers();
  }

  // ----------------- Button handlers -----------------
  function attachFollowButtonHandlers() {
    const buttons = document.querySelectorAll(".follow-btn");
    buttons.forEach(btn => {
      btn.addEventListener("click", async (e) => {
        e.stopPropagation(); // prevent card click
        const userData = JSON.parse(localStorage.getItem("user") || "null");
        if (!userData) {
          alert("Please log in to follow users.");
          window.location.href = "login.html";
          return;
        }

        const followerId = userData.pk_user_id;
        const followedId = btn.getAttribute("data-userid");

        btn.classList.add("loading");

        try {
          const res = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              key: SECRET_KEY,
              action: "follow",
              followerId,
              followedId
            })
          });

          const data = await res.json();
          // server must return { success: true, followed: true } or { success: true, followed: false }
          btn.classList.remove("loading");

          if (data && data.success) {
            const nowFollowed = !!data.followed;
            // update button visuals immediately
            btn.innerHTML = nowFollowed ? svgFollowFilled() : svgFollowOutline();
            btn.setAttribute("aria-pressed", nowFollowed);
            // keep the in-memory set in sync so refreshless interactions are consistent
            if (nowFollowed) followingSet.add(String(followedId));
            else followingSet.delete(String(followedId));
          } else {
            alert(data && data.error ? data.error : "Unexpected response from server.");
          }
        } catch (err) {
          btn.classList.remove("loading");
          alert("Follow/unfollow failed: " + err.message);
        }
      });
    });
  }

  // ----------------- Search -----------------
  function filterUsers() {
    const term = document.getElementById("searchUsers").value.toLowerCase();
    const filtered = allUsers.filter(u =>
      (u.username || "").toLowerCase().includes(term) ||
      (u.name || "").toLowerCase().includes(term) ||
      (u.bio || "").toLowerCase().includes(term)
    );
    renderUsers(filtered);
  }

  // ----------------- Top logged-in card -----------------
  async function loadLoggedInUser() {
    const userData = JSON.parse(localStorage.getItem("user") || "null");
    const container = document.getElementById("loggedInCard");

    if (!userData || !userData.username) {
      container.innerHTML = `
        <div class="user-card" style="text-align:center;">
          <p>No user is currently logged in.</p>
          <p><a href="login.html">Login</a> or <a href="create.html">Create an Account</a></p>
        </div>`;
      return;
    }

    // fetch full profile details (so we can show name, bio, pk_user_id consistently)
    try {
      const res = await fetch(`${API_URL}?type=users`);
      const users = await res.json();
      const me = users.find(u => u.username === userData.username) || {};

      container.innerHTML = `
        <div class="user-card">
          <div class="user-info">
            <div class="user-header">
              <strong>${me.name || userData.name || userData.username}</strong>
              <a href="user.html?id=${me.id || userData.pk_user_id}&from=users.html">@${userData.username}</a>
            </div>
            <div class="user-bio">${me.bio || userData.bio || "No bio yet"}</div>
            <div class="user-followers">Followers: —</div>
          </div>
          <button onclick="logout()" class="logout-btn" title="Log out">
            ${svgLogout()}
          </button>
        </div>`;
    } catch (err) {
      // fallback: render minimal
      container.innerHTML = `
        <div class="user-card">
          <div class="user-info">
            <div class="user-header"><strong>${userData.name || userData.username}</strong>
              <a href="user.html?id=${userData.pk_user_id}&from=users.html">@${userData.username}</a>
            </div>
            <div class="user-bio">${userData.bio || "No bio yet"}</div>
            <div class="user-followers">Followers: —</div>
          </div>
          <button onclick="logout()" class="logout-btn" title="Log out">${svgLogout()}</button>
        </div>`;
    }
  }

  function logout() {
    localStorage.removeItem("user");
    window.location.href = "login.html";
  }

  // startup
  loadUsers();
  </script>
</body>
</html>
